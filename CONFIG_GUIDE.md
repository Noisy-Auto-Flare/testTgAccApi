#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CONFIG GUIDE - Практический гайд по конфигурации testTgAccApi
С подробными примерами для каждого сценария использования
"""

# ============================================================================
# ЧАСТЬ 1: БАЗОВАЯ КОНФИГУРАЦИЯ (Один аккаунт, базовые функции)
# ============================================================================

"""
📝 config.json для новичка (базовая конфигурация)

Используйте этот пример, если:
  ✓ Первый запуск проекта
  ✓ Один аккаунт
  ✓ Хотите просто авторизоваться и ловить сообщения
"""

CONFIG_BASIC = """{
  "telegram": {
    "api_id": 123456,
    "api_hash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  },
  "accounts": [
    {
      "name": "myaccount",
      "session_file": null,
      "phone": "+79001234567",
      "llm": {
        "enabled": false
      },
      "media_forward": {
        "enabled": false
      }
    }
  ]
}
"""

print("""
✅ ЧТО НУЖНО СДЕЛАТЬ:
1. Откройте https://my.telegram.org
2. Получите api_id (число) и api_hash (строка)
3. Скопируйте ваш номер телефона (с кодом страны)
4. Вставьте в config.json (замените значения выше)
5. Запустите: python3 main.py

При первом запуске:
  • Введите номер телефона
  • Введите код из Telegram
  • Готово! Сессия сохранена, при следующих запусках кода ввода не потребуется
""")

# ============================================================================
# ЧАСТЬ 2: ИСПОЛЬЗОВАНИЕ .SESSION ФАЙЛА
# ============================================================================

"""
📝 config.json с .session файлом

Используйте этот пример, если:
  ✓ Уже авторизовались и сохранили .session
  ✓ Хотите быстрый запуск без ввода кода
  ✓ Хотите передать готовую сессию между машинами
"""

CONFIG_WITH_SESSION = """{
  "telegram": {
    "api_id": 123456,
    "api_hash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  },
  "accounts": [
    {
      "name": "backup_account",
      "session_file": "./sessions/backup.session",
      "phone": null,
      "llm": {
        "enabled": false
      },
      "media_forward": {
        "enabled": false
      }
    }
  ]
}
"""

print("""
✅ КАК ПОДГОТОВИТЬ .SESSION ФАЙЛ:

Способ 1: Через интерактивный помощник
  $ python3 setup.py
  Выберите пункт 2 "Авторизоваться и сохранить .session файл"
  Следуйте инструкциям
  Сессия сохранится в sessions/myaccount.session

Способ 2: Из существующей сессии
  $ mkdir -p sessions
  $ cp /path/to/existing.session sessions/backup.session
  
Способ 3: При первом запуске main.py
  • Пока session_file = null, введите phone
  • При первом запуске сессия автоматически сохранится
  • Потом измените phone на null, добавьте session_file

✅ ЧТО ПРОИСХОДИТ:
  • phone = null, session_file указан → использует готовую сессию
  • Авторизация пропускается (пока сессия валидна)
  • Очень быстрый запуск!
""")

# ============================================================================
# ЧАСТЬ 3: ВКЛЮЧЕНИЕ LLM (АВТО-ОТВЕТЫ)
# ============================================================================

"""
📝 config.json с LLM для автоответов

Используйте этот пример, если:
  ✓ Хотите автоматические ответы через AI
  ✓ Установлен text-generation-webui
  ✓ Нужны умные ответы на сообщения
"""

CONFIG_WITH_LLM = """{
  "telegram": {
    "api_id": 123456,
    "api_hash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  },
  "accounts": [
    {
      "name": "smart_account",
      "session_file": "./sessions/account.session",
      "phone": null,
      "llm": {
        "enabled": true,
        "api_url": "http://127.0.0.1:5000/api/v1/chat/completions",
        "api_key": null,
        "system_prompt": "Ты дружелюбный ассистент в Telegram. Помогай людям. Отвечай кратко, максимум 150 символов.",
        "allowed_chat_ids": [123456789, 987654321],
        "timeout": 60
      },
      "media_forward": {
        "enabled": false
      }
    }
  ]
}
"""

print("""
✅ НАСТРОЙКА LLM:

1. Установите text-generation-webui:
   $ git clone https://github.com/oobabooga/text-generation-webui.git
   $ cd text-generation-webui
   $ bash start_linux.sh  # или start_macos.sh для macOS

2. Запустится на http://127.0.0.1:5000

3. В веб-интерфейсе:
   • Session → Server
   • Включите "OpenAI-like API"
   • Сохраните и перезагрузитесь

✅ ПАРАМЕТРЫ LLM:

• api_url - адрес вашей LLM API
  - text-generation-webui: http://127.0.0.1:5000/api/v1/chat/completions
  - LM Studio: обычно http://127.0.0.1:8000/v1/chat/completions
  - Ollama: http://127.0.0.1:11434/v1/chat/completions

• system_prompt - роль и поведение AI
  Примеры:
  - "Ты полезный ассистент. Отвечай кратко."
  - "Ты funny bot. Шути и развлекай пользователя."
  - "Ты профессиональный консультант. Давай экспертные ответы."

• allowed_chat_ids - какие чаты обрабатывать
  - пусто [] = все чаты
  - [123456789] = только один чат
  - [123456789, 987654321] = несколько чатов

• timeout - сколько ждать ответа от LLM
  - 30 = быстро (для быстрых моделей)
  - 60 = стандартно (рекомендуется)
  - 120 = долго (для медленных моделей)

✅ КАК УЗНАТЬ ID ЧАТА:
  $ python3 setup.py
  Выберите пункт 3 "Получить IDs чатов и каналов"
  Результат сохранится в chat_ids.json
""")

# ============================================================================
# ЧАСТЬ 4: ВКЛЮЧЕНИЕ MEDIA FORWARDER (ПЕРЕСЫЛКА МЕДИА)
# ============================================================================

"""
📝 config.json с Media Forwarder

Используйте этот пример, если:
  ✓ Хотите архивировать медиа в отдельный канал
  ✓ Нужна автоматическая пересылка фото/видео
  ✓ Хотите создать резервную копию медиа
"""

CONFIG_WITH_MEDIA_FORWARD = """{
  "telegram": {
    "api_id": 123456,
    "api_hash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  },
  "accounts": [
    {
      "name": "archive_account",
      "session_file": "./sessions/account.session",
      "phone": null,
      "llm": {
        "enabled": false
      },
      "media_forward": {
        "enabled": true,
        "source_chat_ids": [123456789, -100987654321],
        "target_channel_id": -100555666777,
        "include_captions": true
      }
    }
  ]
}
"""

print("""
✅ НАСТРОЙКА MEDIA FORWARDER:

• source_chat_ids - какие чаты мониторить
  - 123456789 = личный чат/группа (положительное число)
  - -100987654321 = канал (отрицательное число, начинается с -100)
  - [123456789, -100987654321] = несколько источников

• target_channel_id - куда пересылать
  - Должен быть приватный канал
  - У аккаунта должны быть права на отправку сообщений
  - Пример: -100555666777

• include_captions - добавлять ли информацию об источнике
  - true = добавлять "From: @username" в подпись
  - false = только оригинальная подпись

✅ КАК УЗНАТЬ ID КАНАЛА:
  
  Способ 1: Через setup.py
    $ python3 setup.py
    Выберите пункт 3 "Получить IDs чатов и каналов"

  Способ 2: Вручную в Telegram Desktop
    • Зайдите в Settings → Advanced
    • Включите "Show IDs"
    • Откройте нужный канал
    • ID будет виден в окне канала

  Способ 3: Через код
    from telethon import TelegramClient
    await client.start()
    entity = await client.get_entity("@channel_username")
    print(entity.id)  # -100123456789

✅ ПРИМЕР ДЛЯ АРХИВА:
  • source_chat_ids: все чаты, откуда нужен медиа
  • target_channel_id: ваш приватный архивный канал
  • include_captions: true (чтобы знать откуда что)
""")

# ============================================================================
# ЧАСТЬ 5: ВСЕ ФУНКЦИИ ВМЕСТЕ
# ============================================================================

"""
📝 config.json со всеми тремя функциями

Используйте этот пример, если:
  ✓ Хотите максимальный функционал
  ✓ Авто-ответы + архивирование медиа
  ✓ Готовые .session файлы
"""

CONFIG_FULL = """{
  "telegram": {
    "api_id": 123456,
    "api_hash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  },
  "accounts": [
    {
      "name": "smart_bot",
      "session_file": "./sessions/smart_bot.session",
      "phone": null,
      "llm": {
        "enabled": true,
        "api_url": "http://127.0.0.1:5000/api/v1/chat/completions",
        "api_key": null,
        "system_prompt": "Ты забавный бот. Шути, помогай, но будь кратким. Максимум 100 символов на ответ.",
        "allowed_chat_ids": [123456789],
        "timeout": 60
      },
      "media_forward": {
        "enabled": true,
        "source_chat_ids": [123456789, -100987654321],
        "target_channel_id": -100555666777,
        "include_captions": true
      }
    }
  ]
}
"""

print("""
✅ ЧТО ПРОИСХОДИТ:
  1. Бот загружается с готовой сессией
  2. Входящие сообщения из чата 123456789 обрабатываются LLM
  3. На каждое сообщение приходит автоответ
  4. Одновременно все фото/видео из двух источников пересылаются в архив
  5. Все работает параллельно и независимо!
""")

# ============================================================================
# ЧАСТЬ 6: НЕСКОЛЬКО АККАУНТОВ
# ============================================================================

"""
📝 config.json с несколькими аккаунтами

Используйте этот пример, если:
  ✓ Нужно управлять несколькими аккаунтами одновременно
  ✓ Разные функции для разных аккаунтов
  ✓ Централизованное управление из одного конфига
"""

CONFIG_MULTI_ACCOUNT = """{
  "telegram": {
    "api_id": 123456,
    "api_hash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  },
  "accounts": [
    {
      "name": "account1_smart",
      "session_file": "./sessions/account1.session",
      "phone": null,
      "llm": {
        "enabled": true,
        "api_url": "http://127.0.0.1:5000/api/v1/chat/completions",
        "system_prompt": "Ты дружелюбный помощник.",
        "allowed_chat_ids": [111111111],
        "timeout": 60
      },
      "media_forward": {
        "enabled": false
      }
    },
    {
      "name": "account2_archiver",
      "session_file": "./sessions/account2.session",
      "phone": null,
      "llm": {
        "enabled": false
      },
      "media_forward": {
        "enabled": true,
        "source_chat_ids": [222222222],
        "target_channel_id": -100888888888,
        "include_captions": true
      }
    },
    {
      "name": "account3_monitor",
      "session_file": "./sessions/account3.session",
      "phone": null,
      "llm": {
        "enabled": false
      },
      "media_forward": {
        "enabled": false
      }
    }
  ]
}
"""

print("""
✅ ПРИМЕР: 3 АККАУНТА С РАЗНЫМИ ФУНКЦИЯМИ

Account 1 (smart_bot):
  ✓ Отвечает на сообщения через LLM
  ✓ Только в чате 111111111
  ✗ Не пересылает медиа

Account 2 (archiver):
  ✗ Не отвечает на сообщения
  ✓ Архивирует медиа из чата 222222222
  ✓ Пересылает в канал -100888888888

Account 3 (monitor):
  ✗ Просто мониторит сообщения
  ✗ Ничего не архивирует

✅ ЧТО ПРОИСХОДИТ:
  $ python3 main.py
  
  • Все 3 аккаунта подключаются одновременно
  • Account 1 начинает отвечать на сообщения
  • Account 2 начинает архивировать медиа
  • Account 3 просто ловит сообщения
  • Все работают параллельно!

✅ КАК ПОДГОТОВИТЬ СЕССИИ:
  1. Авторизуйтесь для каждого аккаунта:
     $ python3 setup.py
     Выберите пункт 2 (3 раза для 3 аккаунтов)
  
  2. Сессии сохранятся:
     • sessions/account1.session
     • sessions/account2.session
     • sessions/account3.session
  
  3. Все готово!
""")

# ============================================================================
# ЧАСТЬ 7: ПРАКТИЧЕСКИЕ СЦЕНАРИИ
# ============================================================================

print("""
═══════════════════════════════════════════════════════════════════════════════

🎯 ПРАКТИЧЕСКИЕ СЦЕНАРИИ

═══════════════════════════════════════════════════════════════════════════════

📌 СЦЕНАРИЙ 1: Я новичок, хочу просто авторизоваться

Config:
{
  "telegram": {
    "api_id": YOUR_API_ID,
    "api_hash": "YOUR_API_HASH"
  },
  "accounts": [
    {
      "name": "mybot",
      "session_file": null,
      "phone": "+79001234567",
      "llm": { "enabled": false },
      "media_forward": { "enabled": false }
    }
  ]
}

Запуск:
$ python3 main.py
Введите код из Telegram → Ready!

─────────────────────────────────────────────────────────────────────────────

📌 СЦЕНАРИЙ 2: Хочу smart bot с авто-ответами

Шаги:
1. Установите text-generation-webui
2. Запустите: bash start_linux.sh
3. Включите OpenAI API в Settings

Config:
{
  "telegram": {...},
  "accounts": [
    {
      "name": "smartbot",
      "session_file": "./sessions/smartbot.session",
      "phone": null,
      "llm": {
        "enabled": true,
        "api_url": "http://127.0.0.1:5000/api/v1/chat/completions",
        "system_prompt": "Ты помощник. Помогай коротко.",
        "allowed_chat_ids": [123456789],
        "timeout": 60
      },
      "media_forward": { "enabled": false }
    }
  ]
}

Проверка:
$ python3 setup.py
Выберите пункт 4 "Проверить соединение с LLM API"

─────────────────────────────────────────────────────────────────────────────

📌 СЦЕНАРИЙ 3: Хочу архивировать медиа из чатов

Шаги:
1. Создайте приватный канал в Telegram (например, @myarchive)
2. Узнайте его ID:
   $ python3 setup.py → пункт 3
3. Узнайте IDs чатов-источников:
   $ python3 setup.py → пункт 3

Config:
{
  "telegram": {...},
  "accounts": [
    {
      "name": "archiver",
      "session_file": "./sessions/archiver.session",
      "phone": null,
      "llm": { "enabled": false },
      "media_forward": {
        "enabled": true,
        "source_chat_ids": [111111, -100222222],
        "target_channel_id": -100333333,
        "include_captions": true
      }
    }
  ]
}

Запуск:
$ python3 main.py
Теперь все фото/видео будут пересылаться автоматически!

─────────────────────────────────────────────────────────────────────────────

📌 СЦЕНАРИЙ 4: Я продвинутый пользователь, нужно все!

Config: используйте CONFIG_MULTI_ACCOUNT (выше)

Это даст вам:
✓ Несколько аккаунтов
✓ Разные функции для каждого
✓ Полный контроль над поведением

─────────────────────────────────────────────────────────────────────────────

📌 СЦЕНАРИЙ 5: Разные модели LLM для разных аккаунтов

Config:
{
  "telegram": {...},
  "accounts": [
    {
      "name": "account_fast",
      "llm": {
        "enabled": true,
        "api_url": "http://127.0.0.1:5000/api/v1/chat/completions",
        "system_prompt": "Ты быстрый помощник",
        "allowed_chat_ids": [111111],
        "timeout": 30
      }
    },
    {
      "name": "account_smart",
      "llm": {
        "enabled": true,
        "api_url": "http://127.0.0.1:8000/v1/chat/completions",
        "system_prompt": "Ты умный помощник",
        "allowed_chat_ids": [222222],
        "timeout": 90
      }
    }
  ]
}

Примечание: разные api_url могут указывать на разные модели или сервисы!

─────────────────────────────────────────────────────────────────────────────

═══════════════════════════════════════════════════════════════════════════════

✅ ЧАСТЫЕ ВОПРОСЫ ПРИ КОНФИГУРАЦИИ

═══════════════════════════════════════════════════════════════════════════════

❓ Как узнать ID чата?
✓ python3 setup.py → пункт 3 "Получить IDs чатов и каналов"
✓ Результаты сохранятся в chat_ids.json

❓ Где взять api_id и api_hash?
✓ Откройте https://my.telegram.org
✓ Login by phone
✓ API development tools
✓ Create/view application

❓ session_file или phone - что выбрать?
✓ session_file: если есть готовая сессия (phone = null)
✓ phone: если нужна авторизация (session_file = null)
✓ Никогда не оба одновременно!

❓ Что если LLM API недоступен?
✓ Бот отправит сообщение об ошибке
✓ Проверьте, что API запущена
✓ Проверьте адрес и порт в config.json
✓ python3 setup.py → пункт 4 для проверки

❓ Как обновить model в text-generation-webui?
✓ В веб-интерфейсе: Download model
✓ Найти нужную модель
✓ Скачать
✓ Model → выбрать → Load

❓ Можно ли использовать LLM и Media Forwarder одновременно?
✓ Да! Они работают независимо
✓ LLM обрабатывает текстовые сообщения
✓ Media Forwarder ловит только медиа

❓ Почему сессия не сохраняется?
✓ Проверьте, что папка sessions/ существует
✓ Проверьте права доступа: chmod 755 sessions/
✓ После авторизации файл должен быть в sessions/

❓ Как использовать разные аккаунты?
✓ Добавьте их в массив "accounts"
✓ Каждому дайте уникальное имя (name)
✓ Разные session_file или phone для каждого
✓ При запуске все будут работать параллельно

❓ Сколько аккаунтов можно подключить?
✓ Теоретически неограниченно
✓ На практике зависит от мощности машины
✓ Каждый аккаунт = отдельное соединение + обработчики

❓ Что произойдет, если config.json неверный?
✓ Программа выведет ошибку при запуске
✓ Проверьте JSON синтаксис (используйте jsonlint)
✓ Убедитесь, что api_id это число, api_hash это строка

═══════════════════════════════════════════════════════════════════════════════

🎓 ИТОГОВЫЕ СОВЕТЫ

═══════════════════════════════════════════════════════════════════════════════

1️⃣  Начните с БАЗОВОЙ конфигурации
   • Только один аккаунт
   • Без LLM и Media Forwarder
   • Убедитесь, что авторизация работает

2️⃣  Затем добавьте одну функцию за раз
   • Сначала LLM
   • Потом Media Forwarder
   • Убедитесь, что каждая работает отдельно

3️⃣  Используйте examples.py для тестирования
   • python3 examples.py
   • Выберите примеры
   • Смотрите, как все работает

4️⃣  Используйте setup.py для диагностики
   • python3 setup.py
   • Пункт 3 для IDs чатов
   • Пункт 4 для проверки LLM API

5️⃣  Читайте логи при ошибках
   • python3 main.py 2>&1 | tee log.txt
   • Ищите ошибки в логах
   • google + error message обычно помогает

═══════════════════════════════════════════════════════════════════════════════

✨ ГОТОВЫ К ЗАПУСКУ!

Скопируйте нужный конфиг выше, сохраните в config.json и запустите:
$ python3 main.py

═══════════════════════════════════════════════════════════════════════════════
""")
